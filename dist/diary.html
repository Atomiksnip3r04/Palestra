<!doctype html>
<html lang="it">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, viewport-fit=cover"
        />
        <title>Diario | GYMBRO</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Oswald:wght@500;700&display=swap"
            rel="stylesheet"
        />
        <link rel="manifest" href="manifest.json" />
        <meta name="theme-color" content="#00f3ff" />

        <!-- iOS Support -->
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta
            name="apple-mobile-web-app-status-bar-style"
            content="black-translucent"
        />
        <meta name="apple-mobile-web-app-title" content="GymBro" />
        <link rel="apple-touch-icon" href="assets/icon.svg" />

        <link rel="icon" type="image/svg+xml" href="assets/icon.svg" />
        <link rel="stylesheet" href="css/style.css" />
        <link rel="stylesheet" href="css/gymbro-chat.css" />
        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
        <style>
            /* =========================
           LOG ENTRY CARDS - Compatte e Professionali
           ========================= */
            .log-entry {
                background: linear-gradient(
                    145deg,
                    var(--color-surface) 0%,
                    rgba(0, 0, 0, 0.15) 100%
                );
                border-radius: 12px;
                padding: 0.75rem 1rem;
                margin-bottom: 0.6rem;
                position: relative;
                border: 1px solid rgba(255, 255, 255, 0.08);
                transition:
                    transform 0.15s,
                    box-shadow 0.15s;
            }

            .log-entry:active {
                transform: scale(0.98);
            }

            /* Bordo laterale colorato - AI vs Manuale */
            .log-entry::before {
                content: "";
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 4px;
                background: var(--color-primary);
                border-radius: 12px 0 0 12px;
            }

            .log-entry.ai-generated::before {
                background: linear-gradient(
                    180deg,
                    var(--color-primary) 0%,
                    #00c8d4 100%
                );
            }

            .log-entry.manual::before {
                background: rgba(255, 255, 255, 0.3);
            }

            /* Header Card - Livello 1: Data + Azioni */
            .log-entry-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.25rem;
            }

            .log-date {
                font-size: 0.75rem;
                color: var(--color-text-muted);
                text-transform: capitalize;
            }

            /* Azioni - Distanziate e touch-friendly */
            .log-actions {
                display: flex;
                gap: 0.75rem;
                align-items: center;
            }

            .log-action-btn {
                background: none;
                border: none;
                cursor: pointer;
                font-size: 1.1rem;
                padding: 0.35rem;
                border-radius: 8px;
                transition:
                    background 0.15s,
                    transform 0.15s;
                min-width: 36px;
                min-height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .log-action-btn:hover {
                background: rgba(255, 255, 255, 0.08);
            }

            .log-action-btn:active {
                transform: scale(0.9);
            }

            .log-action-btn.delete-btn {
                color: #ff4444;
            }

            .log-action-btn.delete-btn:hover {
                background: rgba(255, 68, 68, 0.15);
            }

            /* Livello 2: Titolo */
            .log-title {
                font-family: var(--font-display);
                font-size: 1.05rem;
                font-weight: 600;
                color: var(--color-text-main);
                margin-bottom: 0.35rem;
                line-height: 1.2;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: calc(100% - 10px);
            }

            /* Livello 3: Stats inline */
            .log-stats {
                display: flex;
                gap: 0.5rem;
                align-items: center;
                flex-wrap: wrap;
            }

            .stat-pill {
                display: inline-flex;
                align-items: center;
                gap: 0.25rem;
                background: rgba(255, 255, 255, 0.06);
                padding: 0.2rem 0.5rem;
                border-radius: 6px;
                font-size: 0.8rem;
                color: var(--color-text-muted);
            }

            .stat-pill .stat-icon {
                font-size: 0.75rem;
            }

            .stat-pill .stat-value {
                color: var(--color-text-main);
                font-weight: 500;
            }

            /* Badge AI integrato nei pill */
            .stat-pill.ai-pill {
                background: rgba(0, 243, 255, 0.12);
                border: 1px solid rgba(0, 243, 255, 0.25);
                color: var(--color-primary);
                font-size: 0.7rem;
                font-weight: 600;
                letter-spacing: 0.03em;
            }

            .delete-log-btn {
                color: #ff4444;
                cursor: pointer;
                font-size: 1.2rem;
                background: none;
                border: none;
                padding: 0;
            }

            /* =========================
           FLOATING ACTION BUTTON
           ========================= */
            .fab-container {
                position: fixed;
                bottom: calc(100px + env(safe-area-inset-bottom, 0px));
                right: 1rem;
                z-index: 100;
            }

            .fab {
                width: 56px;
                height: 56px;
                border-radius: 16px;
                background: linear-gradient(
                    135deg,
                    var(--color-primary) 0%,
                    #00c8d4 100%
                );
                border: none;
                color: var(--color-bg);
                font-size: 1.5rem;
                cursor: pointer;
                box-shadow:
                    0 4px 20px rgba(0, 243, 255, 0.4),
                    0 2px 8px rgba(0, 0, 0, 0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                transition:
                    transform 0.2s,
                    box-shadow 0.2s;
            }

            .fab:hover {
                transform: scale(1.05);
                box-shadow:
                    0 6px 28px rgba(0, 243, 255, 0.5),
                    0 4px 12px rgba(0, 0, 0, 0.4);
            }

            .fab:active {
                transform: scale(0.95);
            }

            /* Page Header Bilanciato */
            .diary-page-header {
                display: flex;
                justify-content: space-between;
                align-items: baseline;
                margin-bottom: var(--spacing-md);
                gap: 1rem;
            }

            .diary-page-header h1 {
                margin: 0;
                font-size: clamp(1.5rem, 5vw, 2rem);
            }

            /* Empty State */
            .empty-state {
                text-align: center;
                color: var(--color-text-muted);
                padding: 3rem 1rem;
            }

            .empty-state-icon {
                font-size: 3rem;
                margin-bottom: 1rem;
                opacity: 0.5;
            }

            .empty-state-text {
                font-size: 0.95rem;
                margin-bottom: 1rem;
            }

            /* Logging Form Styles - COMPATTO */
            .logging-section {
                background: linear-gradient(
                    145deg,
                    var(--color-surface) 0%,
                    rgba(0, 0, 0, 0.2) 100%
                );
                padding: clamp(0.75rem, 3vw, 1.25rem);
                border-radius: 16px;
                margin-bottom: var(--spacing-md);
                border: 1px solid rgba(0, 243, 255, 0.2);
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.05);
                max-width: 100%;
                padding-bottom: 100px;
                /* Spazio per sticky footer */
            }

            /* Header Metadati Compatto */
            .logging-header {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                margin-bottom: 0.75rem;
                padding-bottom: 0.5rem;
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            }

            .logging-header-icon {
                width: 32px;
                height: 32px;
                background: linear-gradient(
                    135deg,
                    var(--color-primary) 0%,
                    #00c8d4 100%
                );
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1rem;
                flex-shrink: 0;
            }

            /* Grid compatta Data + Durata */
            .meta-row-primary {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
                margin-bottom: 0.5rem;
            }

            .meta-input-group {
                display: flex;
                align-items: center;
                gap: 0.4rem;
                background: rgba(0, 0, 0, 0.25);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 10px;
                padding: 0.4rem 0.6rem;
            }

            .meta-input-group .meta-icon {
                font-size: 0.9rem;
                opacity: 0.8;
            }

            .meta-input-group input {
                flex: 1;
                background: transparent;
                border: none;
                color: var(--color-text-main);
                font-size: 0.9rem;
                padding: 0.2rem 0;
                min-width: 0;
            }

            .meta-input-group input:focus {
                outline: none;
            }

            .meta-input-group .meta-suffix {
                font-size: 0.7rem;
                color: var(--color-text-muted);
            }

            /* Griglia Wellness 2x2 Compatta con Icone */
            .wellness-compact-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 0.4rem;
                margin-bottom: 0.5rem;
            }

            .wellness-mini-card {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.35rem;
                background: rgba(0, 0, 0, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.08);
                border-radius: 8px;
                padding: 0.5rem 0.25rem;
                position: relative;
            }

            .wellness-mini-card .wellness-icon {
                font-size: 0.9rem;
                line-height: 1;
            }

            /* Help icon on wellness cards */
            .wellness-help-icon {
                position: absolute;
                top: 2px;
                right: 2px;
                width: 14px;
                height: 14px;
                font-size: 10px;
                color: var(--color-primary);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: softPulse 3s ease-in-out infinite;
                z-index: 5;
            }

            @keyframes softPulse {
                0%,
                100% {
                    opacity: 0.4;
                }

                50% {
                    opacity: 1;
                }
            }

            /* Stats Info Modal */
            .stats-info-modal-backdrop {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }

            .stats-info-modal-backdrop.active {
                opacity: 1;
                visibility: visible;
            }

            .stats-info-modal {
                background: var(--color-surface);
                border: 1px solid rgba(0, 255, 255, 0.2);
                border-radius: 16px;
                max-width: 90%;
                width: 380px;
                max-height: 85vh;
                overflow-y: auto;
                padding: 1.5rem;
                transform: scale(0.9);
                transition: transform 0.3s ease;
            }

            .stats-info-modal-backdrop.active .stats-info-modal {
                transform: scale(1);
            }

            .stats-info-modal h3 {
                color: var(--color-primary);
                font-size: 1.1rem;
                margin-bottom: 1rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .stats-info-section {
                margin-bottom: 1rem;
                padding: 0.75rem;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 10px;
                border-left: 3px solid var(--color-primary);
            }

            .stats-info-section h4 {
                font-size: 0.85rem;
                color: var(--color-primary);
                margin-bottom: 0.5rem;
                font-weight: 600;
            }

            .stats-info-section p {
                font-size: 0.8rem;
                color: var(--color-text-muted);
                line-height: 1.5;
                margin: 0;
            }

            .stats-info-close-btn {
                width: 100%;
                padding: 0.75rem;
                background: transparent;
                border: 1px solid var(--color-primary);
                border-radius: 10px;
                color: var(--color-primary);
                font-size: 0.9rem;
                font-weight: 600;
                cursor: pointer;
                margin-top: 0.5rem;
                transition: all 0.2s ease;
            }

            .stats-info-close-btn:hover {
                background: var(--color-primary);
                color: var(--color-bg);
            }

            .wellness-mini-card input {
                width: 100%;
                max-width: 40px;
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 6px;
                color: var(--color-text-main);
                font-size: 0.85rem;
                padding: 0.25rem;
                text-align: center;
            }

            .wellness-mini-card input:focus {
                outline: none;
                border-color: var(--color-primary);
            }

            /* Sticky Footer Actions */
            .sticky-footer-actions {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(
                    to top,
                    var(--color-bg) 0%,
                    var(--color-bg) 85%,
                    transparent 100%
                );
                padding: 1rem;
                padding-bottom: max(1rem, env(safe-area-inset-bottom));
                display: flex;
                gap: 0.75rem;
                z-index: 100;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);
            }

            .sticky-footer-actions .btn-primary {
                flex: 2;
                padding: 0.9rem 1rem;
                font-size: 0.95rem;
                font-weight: 600;
                border-radius: 12px;
            }

            .sticky-footer-actions .btn-outline {
                flex: 1;
                padding: 0.9rem 0.75rem;
                font-size: 0.85rem;
                border-radius: 12px;
            }

            .exercise-log-item {
                margin-bottom: 0.75rem;
                padding: 0.75rem;
                background: linear-gradient(
                    145deg,
                    rgba(255, 255, 255, 0.03) 0%,
                    rgba(0, 0, 0, 0.12) 100%
                );
                border: 1px solid rgba(255, 255, 255, 0.08);
                border-radius: 12px;
                position: relative;
            }

            .exercise-log-item:last-child {
                margin-bottom: 0.5rem;
            }

            /* Exercise Card Header - Inline compatto */
            .exercise-card-header {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                margin-bottom: 0.5rem;
            }

            .drag-handle {
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--color-text-muted);
                cursor: grab;
                padding: 0.25rem;
                font-size: 1rem;
                opacity: 0.4;
                transition: opacity 0.2s;
                flex-shrink: 0;
            }

            .drag-handle:active {
                cursor: grabbing;
            }

            .exercise-log-item:hover .drag-handle {
                opacity: 0.8;
            }

            .exercise-name-input {
                flex: 1;
                min-width: 0;
                padding: 0.4rem 0.5rem !important;
                background: rgba(0, 0, 0, 0.25) !important;
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                color: var(--color-text-main) !important;
                border-radius: 8px !important;
                font-size: 0.9rem !important;
                font-weight: 600 !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .exercise-name-input:focus {
                border-color: var(--color-primary) !important;
                outline: none;
            }

            .exercise-header-actions {
                display: flex;
                gap: 0.3rem;
                flex-shrink: 0;
            }

            .exercise-header-actions button {
                padding: 0.3rem 0.5rem !important;
                font-size: 0.7rem !important;
                border-radius: 6px !important;
                min-width: 0;
                white-space: nowrap;
            }

            .sortable-ghost {
                opacity: 0.4;
                background: var(--color-primary-faded, rgba(0, 243, 255, 0.1));
                border: 2px dashed var(--color-primary) !important;
            }

            .set-row {
                display: grid;
                grid-template-columns: 0.5fr 1fr 1fr 1fr auto;
                gap: 10px;
                align-items: center;
                margin-bottom: 0.5rem;
            }

            @media (max-width: 480px) {
                .set-row,
                .set-header {
                    grid-template-columns: 30px 1fr 1fr 1fr 30px !important;
                    gap: 4px !important;
                }

                .set-input {
                    padding: 0.4rem 0.2rem !important;
                    font-size: 0.9rem !important;
                }

                .set-label {
                    font-size: 0.8rem !important;
                }
            }

            .set-label {
                font-size: 0.8rem;
                color: var(--color-text-muted);
                text-align: center;
            }

            .set-input {
                width: 100%;
                padding: 0.6rem;
                background: rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.12);
                color: var(--color-text-main);
                border-radius: 10px;
                text-align: center;
                transition:
                    border-color 0.2s,
                    box-shadow 0.2s;
            }

            .set-input:focus {
                border-color: var(--color-primary);
                box-shadow: 0 0 0 2px rgba(0, 243, 255, 0.15);
                outline: none;
            }

            .set-header {
                display: grid;
                grid-template-columns: 0.5fr 1fr 1fr 1fr auto;
                gap: 10px;
                margin-bottom: 0.5rem;
                font-size: 0.8rem;
                color: var(--color-text-muted);
                text-align: center;
            }

            .ai-badge {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                background: rgba(0, 243, 255, 0.1);
                color: var(--color-primary);
                border: 1px solid rgba(0, 243, 255, 0.2);
                border-radius: 999px;
                font-size: 0.65rem;
                padding: 0 0.5rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }
        </style>
        <style>
            /* ... existing styles ... */
            .exercise-log-item {
                margin-bottom: 1.5rem;
                background: linear-gradient(
                    145deg,
                    rgba(255, 255, 255, 0.03) 0%,
                    rgba(0, 0, 0, 0.15) 100%
                );
                padding: 1.25rem;
                border-radius: 16px;
                border: 1px solid rgba(255, 255, 255, 0.08);
                position: relative;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                transition:
                    border-color 0.2s,
                    box-shadow 0.2s;
            }

            .exercise-log-item:hover {
                border-color: rgba(255, 255, 255, 0.15);
            }

            .exercise-log-item:focus-within {
                border-color: rgba(0, 243, 255, 0.3);
                box-shadow: 0 4px 16px rgba(0, 243, 255, 0.1);
            }

            .exercise-log-item.in-superset {
                border-left: 3px solid #ff6b6b;
                background: linear-gradient(
                    to right,
                    rgba(255, 107, 107, 0.08),
                    rgba(255, 255, 255, 0.03) 20%,
                    rgba(0, 0, 0, 0.15) 100%
                );
            }

            .superset-indicator {
                display: inline-block;
                background: #ff6b6b;
                color: white;
                font-size: 0.7rem;
                padding: 2px 6px;
                border-radius: 4px;
                margin-bottom: 0.5rem;
                font-weight: bold;
            }

            .superset-controls {
                margin-top: 1rem;
                padding-top: 0.5rem;
                border-top: 1px dashed var(--color-border);
                display: flex !important;
                gap: 0.5rem;
                flex-wrap: wrap;
            }

            .superset-btn {
                background: none;
                border: 1px solid var(--color-border);
                color: var(--color-text-muted);
                padding: 0.3rem 0.6rem;
                border-radius: 4px;
                font-size: 0.8rem;
                cursor: pointer;
                transition: all 0.2s;
            }

            .superset-btn:hover {
                background: rgba(255, 255, 255, 0.05);
                color: var(--color-text-main);
            }

            .superset-rest-config {
                display: none;
                margin-top: 0.5rem;
                padding: 0.5rem 0.6rem;
                background: rgba(255, 107, 107, 0.08);
                border: 1px solid rgba(255, 107, 107, 0.2);
                border-radius: 8px;
            }

            .superset-rest-config.visible {
                display: block;
            }

            .superset-rest-title {
                font-size: 0.75rem;
                color: #ff6b6b;
                font-weight: 500;
                margin-bottom: 0.4rem;
                display: flex;
                align-items: center;
                gap: 0.3rem;
            }

            /* Griglia allineata per Superset rest */
            .superset-rest-grid {
                display: grid;
                grid-template-columns: 1fr auto;
                gap: 0.3rem 0.5rem;
                align-items: center;
            }

            .superset-rest-grid .rest-label {
                font-size: 0.75rem;
                color: var(--color-text-muted);
                text-align: right;
            }

            .superset-rest-grid .rest-value-box {
                display: flex;
                align-items: center;
                gap: 0.25rem;
            }

            .superset-rest-grid input {
                width: 50px;
                background: rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.15);
                color: white;
                padding: 0.3rem;
                text-align: center;
                border-radius: 6px;
                font-size: 0.85rem;
            }

            .superset-rest-grid input:focus {
                outline: none;
                border-color: #ff6b6b;
            }

            .superset-rest-grid .rest-suffix {
                font-size: 0.7rem;
                color: var(--color-text-muted);
            }

            .rest-input-row {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.8rem;
                margin-bottom: 0.3rem;
            }

            .rest-input-row input {
                width: 50px;
                background: var(--color-bg);
                border: 1px solid var(--color-border);
                color: white;
                padding: 0.2rem;
                text-align: center;
                border-radius: 4px;
            }

            /* Normal Rest Config - Uniforme */
            .normal-rest-config {
                margin-top: 0.4rem;
                margin-bottom: 0.4rem;
            }

            .rest-inline-box {
                display: inline-flex;
                align-items: center;
                gap: 0.3rem;
                background: rgba(0, 0, 0, 0.25);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                padding: 0.3rem 0.5rem;
                font-size: 0.8rem;
            }

            .rest-inline-box .rest-icon {
                font-size: 0.85rem;
                opacity: 0.7;
            }

            .rest-inline-box input {
                width: 45px;
                background: transparent;
                border: none;
                color: white;
                text-align: center;
                font-size: 0.85rem;
                padding: 0;
            }

            .rest-inline-box input:focus {
                outline: none;
            }

            .rest-inline-box .rest-suffix {
                font-size: 0.7rem;
                color: var(--color-text-muted);
            }

            .set-type-select {
                background: rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.12);
                color: var(--color-text-main);
                border-radius: 8px;
                padding: 0.4rem;
                font-size: 0.8rem;
                width: 80px;
                transition: border-color 0.2s;
            }

            .set-type-select:focus {
                border-color: var(--color-primary);
                outline: none;
            }

            /* Grid layout for set row - Allineato */
            .set-row {
                display: grid;
                grid-template-columns: 24px 65px 1fr 1fr 1fr 24px;
                gap: 0.35rem;
                align-items: center;
                margin-bottom: 0.5rem;
            }

            @media (max-width: 480px) {
                .set-row,
                .set-header {
                    grid-template-columns: 20px 55px 1fr 1fr 1fr 20px !important;
                    gap: 2px !important;
                }

                .set-input {
                    padding: 0.35rem 0.1rem !important;
                    font-size: 0.8rem !important;
                }

                .set-type-select {
                    width: 100% !important;
                    font-size: 0.7rem !important;
                    padding: 0.2rem !important;
                }

                .set-label {
                    font-size: 0.7rem !important;
                }

                .wellness-compact-grid {
                    grid-template-columns: repeat(4, 1fr) !important;
                    gap: 0.3rem !important;
                }

                .wellness-mini-card {
                    padding: 0.3rem 0.15rem !important;
                }

                .wellness-mini-card input {
                    max-width: 36px !important;
                    font-size: 0.8rem !important;
                }

                .exercise-name-input {
                    font-size: 0.85rem !important;
                }

                .exercise-header-actions button {
                    padding: 0.25rem 0.4rem !important;
                    font-size: 0.65rem !important;
                }
            }

            .set-header {
                display: grid;
                grid-template-columns: 24px 65px 1fr 1fr 1fr 24px;
                gap: 0.35rem;
                margin-bottom: 0.4rem;
                font-size: 0.75rem;
                color: var(--color-text-muted);
                text-align: center;
            }

            @media (max-width: 480px) {
                #startWorkoutBtn {
                    padding: 0.8rem 1rem !important;
                    font-size: 0.8rem !important;
                    letter-spacing: 0.5px !important;
                    text-align: center;
                    line-height: 1.1;
                    min-width: 110px;
                }
            }
        </style>
    </head>

    <body>
        <header class="header">
            <div class="container">
                <a href="index.html" class="logo"
                    >GYM<span class="text-primary">BRO</span></a
                >
                <nav>
                    <div class="mobile-toggle" id="mobileToggle">‚ò∞</div>
                    <ul class="nav-links" id="navLinks">
                        <li><a href="creator.html">üìù Crea Schede</a></li>
                        <li>
                            <a href="diary.html" class="text-primary"
                                >üìì Diario</a
                            >
                        </li>
                        <li><a href="analysis.html">üìà Analisi</a></li>
                        <li><a href="body.html">üí™ Corpo</a></li>
                        <li><a href="user.html">üë§ Profilo</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <section class="section" style="padding-top: 160px">
            <div class="container">
                <div class="diary-page-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>
                        Diario <span class="text-primary">Allenamento</span>
                    </h1>
                    <button id="manualSyncBtn" class="sync-btn" title="Sincronizza con cloud" style="
                        background: transparent;
                        border: 1px solid var(--primary);
                        color: var(--primary);
                        padding: 8px 12px;
                        border-radius: 20px;
                        font-size: 14px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        transition: all 0.2s;
                    ">
                        <span class="sync-icon">‚òÅÔ∏è</span>
                        <span class="sync-text">Sync</span>
                    </button>
                </div>

                <!-- FAB - Floating Action Button -->
                <div class="fab-container" id="fabContainer">
                    <button
                        id="startWorkoutBtn"
                        class="fab"
                        title="Registra Allenamento"
                    >
                        ‚ûï
                    </button>
                </div>

                <!-- Workout Selector (Hidden by default) -->
                <div
                    id="workoutSelector"
                    class="card"
                    style="
                        display: none;
                        margin-bottom: var(--spacing-md);
                        border-radius: 16px;
                        border: 1px solid rgba(255, 255, 255, 0.1);
                    "
                >
                    <h3 style="margin-bottom: 0.5rem">üéØ Seleziona Scheda</h3>
                    <p
                        style="
                            font-size: 0.85rem;
                            color: var(--color-text-muted);
                            margin-bottom: 1rem;
                        "
                    >
                        Scegli quale routine registrare
                    </p>
                    <select
                        id="savedWorkoutsSelect"
                        style="
                            margin-bottom: 1rem;
                            width: 100%;
                            padding: 0.9rem;
                            border-radius: 12px;
                            background: rgba(0, 0, 0, 0.3);
                            border: 1px solid rgba(255, 255, 255, 0.12);
                            color: white;
                        "
                    >
                        <option value="">-- Scegli una routine --</option>
                    </select>
                    <div style="display: flex; gap: 1rem">
                        <button
                            id="loadWorkoutBtn"
                            class="btn btn-primary"
                            style="flex: 1; border-radius: 12px"
                        >
                            ‚úÖ Carica Scheda
                        </button>
                        <button
                            id="cancelSelectBtn"
                            class="btn btn-outline"
                            style="border-radius: 12px"
                        >
                            Annulla
                        </button>
                    </div>
                </div>

                <!-- Active Logging Area (Hidden by default) -->
                <div
                    id="loggingArea"
                    class="logging-section"
                    style="display: none"
                >
                    <!-- Header Compatto -->
                    <div class="logging-header">
                        <div class="logging-header-icon">üìù</div>
                        <h2
                            id="loggingTitle"
                            style="
                                margin: 0;
                                font-size: 1.1rem;
                                flex: 1;
                                white-space: nowrap;
                                overflow: hidden;
                                text-overflow: ellipsis;
                            "
                        >
                            Log Workout
                        </h2>
                    </div>

                    <!-- Data + Durata - Riga compatta -->
                    <div class="meta-row-primary">
                        <div class="meta-input-group">
                            <span class="meta-icon">üìÖ</span>
                            <input type="date" id="logDate" />
                        </div>
                        <div class="meta-input-group">
                            <span class="meta-icon">‚è±Ô∏è</span>
                            <input
                                type="number"
                                id="logDuration"
                                placeholder="60"
                            />
                            <span class="meta-suffix">min</span>
                        </div>
                    </div>

                    <!-- Wellness Grid 4 colonne con icone -->
                    <div class="wellness-compact-grid">
                        <div
                            class="wellness-mini-card"
                            title="Qualit√† Sonno (1-10)"
                        >
                            <span
                                class="wellness-help-icon"
                                onclick="openStatsInfoModal('sleep')"
                                >?</span
                            >
                            <span class="wellness-icon">üò¥</span>
                            <input
                                type="number"
                                id="logSleepQuality"
                                min="1"
                                max="10"
                                placeholder="7"
                            />
                        </div>
                        <div
                            class="wellness-mini-card"
                            title="Livello Energia (1-10)"
                        >
                            <span
                                class="wellness-help-icon"
                                onclick="openStatsInfoModal('energy')"
                                >?</span
                            >
                            <span class="wellness-icon">üîã</span>
                            <input
                                type="number"
                                id="logEnergyLevel"
                                min="1"
                                max="10"
                                placeholder="7"
                            />
                        </div>
                        <div
                            class="wellness-mini-card"
                            title="Livello Stress (1-10)"
                        >
                            <span
                                class="wellness-help-icon"
                                onclick="openStatsInfoModal('stress')"
                                >?</span
                            >
                            <span class="wellness-icon">üßò</span>
                            <input
                                type="number"
                                id="logStressLevel"
                                min="1"
                                max="10"
                                placeholder="4"
                            />
                        </div>
                        <div
                            class="wellness-mini-card"
                            title="DOMS - Dolori Muscolari (1-10)"
                        >
                            <span
                                class="wellness-help-icon"
                                onclick="openStatsInfoModal('doms')"
                                >?</span
                            >
                            <span class="wellness-icon">üí™</span>
                            <input
                                type="number"
                                id="logSorenessLevel"
                                min="1"
                                max="10"
                                placeholder="3"
                            />
                        </div>
                    </div>

                    <!-- DOMS Details Section - Compatto -->
                    <div
                        id="domsDetailsSection"
                        style="
                            background: rgba(255, 255, 255, 0.02);
                            border: 1px solid rgba(255, 255, 255, 0.06);
                            border-radius: 8px;
                            padding: 0.5rem 0.6rem;
                            margin-bottom: 0.75rem;
                        "
                    >
                        <div
                            style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                            "
                        >
                            <label
                                style="
                                    font-size: 0.8rem;
                                    color: var(--color-text-muted);
                                    font-weight: 500;
                                "
                                >üí™ Dettagli DOMS</label
                            >
                            <button
                                type="button"
                                id="toggleDomsDetails"
                                style="
                                    background: none;
                                    border: none;
                                    color: var(--color-primary);
                                    cursor: pointer;
                                    font-size: 0.75rem;
                                "
                            >
                                Espandi ‚ñº
                            </button>
                        </div>
                        <div
                            id="domsDetailsContent"
                            style="display: none; margin-top: 0.5rem"
                        >
                            <div style="margin-bottom: 0.5rem">
                                <label
                                    style="
                                        font-size: 0.75rem;
                                        color: var(--color-text-muted);
                                        display: block;
                                        margin-bottom: 0.4rem;
                                    "
                                    >Gruppi Muscolari Doloranti</label
                                >
                                <div
                                    id="logSorenessMusclePicker"
                                    style="
                                        display: flex;
                                        flex-wrap: wrap;
                                        gap: 0.3rem;
                                    "
                                >
                                    <!-- Muscle chips will be generated here -->
                                </div>
                                <small
                                    id="logSorenessMuscleHint"
                                    style="
                                        display: block;
                                        margin-top: 0.3rem;
                                        color: var(--color-text-muted);
                                        font-size: 0.7rem;
                                    "
                                    >Nessun gruppo selezionato</small
                                >
                            </div>
                            <div>
                                <label
                                    style="
                                        font-size: 0.75rem;
                                        color: var(--color-text-muted);
                                        display: block;
                                        margin-bottom: 0.3rem;
                                    "
                                    >Causa DOMS / Dolore (opzionale)</label
                                >
                                <input
                                    type="text"
                                    id="logExternalCause"
                                    class="set-input"
                                    style="
                                        width: 100%;
                                        text-align: left;
                                        font-size: 0.85rem;
                                        padding: 0.4rem;
                                    "
                                    placeholder="es. Partita di Padel, Corsa..."
                                />
                            </div>
                        </div>
                    </div>

                    <div id="exercisesLogContainer">
                        <!-- Dynamic Exercises will go here -->
                    </div>

                    <!-- Sticky Footer Actions -->
                    <div
                        class="sticky-footer-actions"
                        id="loggingFooterActions"
                        style="display: none"
                    >
                        <button id="cancelLogBtn" class="btn btn-outline">
                            Annulla
                        </button>
                        <button id="finishWorkoutBtn" class="btn btn-primary">
                            Salva Allenamento
                        </button>
                    </div>
                </div>

                <!-- History List -->
                <div id="historyList">
                    <!-- Logs will be injected here -->
                </div>
            </div>
        </section>

        <script src="js/api.js"></script>
        <script src="js/main.js"></script>
        <!-- Sync Manager - Sincronizzazione centralizzata -->
        <script type="module" src="./js/sync-manager.js"></script>
        <script type="module">
            import { firestoreService } from "./js/firestore-service.js";
            import { authService } from "./js/auth-service.js";
            import { syncManager } from "./js/sync-manager.js";
            import { MUSCLE_GROUPS } from "./js/exercise-db.js";
            import { prTracker } from "./js/pr-tracker.js";

            // Set types configuration (Mirrored from Creator)
            const SET_TYPES = {
                normal: { label: "Normale", color: "normal" },
                warmup: { label: "Warm-up", color: "warmup" },
                backoff: { label: "Back-off", color: "backoff" },
                dropset: { label: "Drop Set", color: "dropset" },
                amrap: { label: "AMRAP", color: "amrap" },
                pause: { label: "Pausa", color: "pause" },
            };

            // Generate set type options HTML
            function getSetTypeOptions(selectedType = "normal") {
                return Object.entries(SET_TYPES)
                    .map(
                        ([key, val]) =>
                            `<option value="${key}" ${key === selectedType ? "selected" : ""}>${val.label}</option>`,
                    )
                    .join("");
            }

            document.addEventListener("DOMContentLoaded", () => {
                let nextSupersetId = 1;

                // Manual Sync Button Handler
                const manualSyncBtn = document.getElementById("manualSyncBtn");
                if (manualSyncBtn) {
                    manualSyncBtn.addEventListener("click", async () => {
                        const syncIcon = manualSyncBtn.querySelector(".sync-icon");
                        const syncText = manualSyncBtn.querySelector(".sync-text");
                        
                        // Disable button and show loading
                        manualSyncBtn.disabled = true;
                        syncIcon.textContent = "üîÑ";
                        syncText.textContent = "...";
                        manualSyncBtn.style.animation = "spin 1s linear infinite";
                        
                        try {
                            // First load from cloud to get latest data
                            console.log("üîÑ Manual sync: loading from cloud...");
                            await syncManager.loadFromCloud();
                            
                            // Then sync local to cloud
                            console.log("üîÑ Manual sync: syncing to cloud...");
                            const result = await syncManager.syncToCloud(true);
                            
                            if (result.success) {
                                syncIcon.textContent = "‚úÖ";
                                syncText.textContent = "OK!";
                                // Refresh the logs display
                                renderLogs();
                            } else {
                                syncIcon.textContent = "‚ùå";
                                syncText.textContent = result.reason === 'not_authenticated' ? "Login!" : "Errore";
                            }
                        } catch (error) {
                            console.error("Manual sync error:", error);
                            syncIcon.textContent = "‚ùå";
                            syncText.textContent = "Errore";
                        }
                        
                        // Reset button after 2 seconds
                        setTimeout(() => {
                            manualSyncBtn.disabled = false;
                            manualSyncBtn.style.animation = "";
                            syncIcon.textContent = "‚òÅÔ∏è";
                            syncText.textContent = "Sync";
                        }, 2000);
                    });
                }
                
                // Add spin animation style
                if (!document.getElementById("sync-spin-style")) {
                    const style = document.createElement("style");
                    style.id = "sync-spin-style";
                    style.textContent = "@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }";
                    document.head.appendChild(style);
                }

                // DOMS Muscle Picker Setup
                const logSorenessMusclePicker = document.getElementById(
                    "logSorenessMusclePicker",
                );
                const logSorenessMuscleHint = document.getElementById(
                    "logSorenessMuscleHint",
                );
                const logExternalCause =
                    document.getElementById("logExternalCause");
                const toggleDomsDetails =
                    document.getElementById("toggleDomsDetails");
                const domsDetailsContent =
                    document.getElementById("domsDetailsContent");

                let selectedLogSorenessMuscles = new Set();

                // Toggle DOMS details section
                toggleDomsDetails.addEventListener("click", () => {
                    const isHidden =
                        domsDetailsContent.style.display === "none";
                    domsDetailsContent.style.display = isHidden
                        ? "block"
                        : "none";
                    toggleDomsDetails.textContent = isHidden
                        ? "Comprimi ‚ñ≤"
                        : "Espandi ‚ñº";
                });

                // Build muscle picker chips
                function buildLogSorenessPicker() {
                    if (!logSorenessMusclePicker) return;
                    logSorenessMusclePicker.innerHTML = "";

                    Object.entries(MUSCLE_GROUPS).forEach(([id, meta]) => {
                        const chip = document.createElement("button");
                        chip.type = "button";
                        chip.className = "doms-chip";
                        chip.dataset.muscle = id;
                        chip.textContent = meta.label;
                        chip.style.cssText = `
                        background: rgba(255, 255, 255, 0.08);
                        border: 1px solid rgba(255, 255, 255, 0.12);
                        color: #fff;
                        border-radius: 999px;
                        padding: 0.25rem 0.6rem;
                        font-size: 0.75rem;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    `;

                        chip.addEventListener("click", () => {
                            if (selectedLogSorenessMuscles.has(id)) {
                                selectedLogSorenessMuscles.delete(id);
                                chip.style.background =
                                    "rgba(255, 255, 255, 0.08)";
                                chip.style.borderColor =
                                    "rgba(255, 255, 255, 0.12)";
                            } else {
                                selectedLogSorenessMuscles.add(id);
                                chip.style.background =
                                    "rgba(0, 243, 255, 0.25)";
                                chip.style.borderColor =
                                    "rgba(0, 243, 255, 0.6)";
                            }
                            updateLogSorenessHint();
                        });

                        logSorenessMusclePicker.appendChild(chip);
                    });
                }

                function updateLogSorenessHint() {
                    if (!logSorenessMuscleHint) return;
                    if (selectedLogSorenessMuscles.size === 0) {
                        logSorenessMuscleHint.textContent =
                            "Nessun gruppo selezionato";
                    } else {
                        const labels = Array.from(
                            selectedLogSorenessMuscles,
                        ).map((id) => MUSCLE_GROUPS[id]?.label || id);
                        logSorenessMuscleHint.textContent = `Selezionati: ${labels.join(", ")}`;
                    }
                }

                function syncLogSorenessChips() {
                    if (!logSorenessMusclePicker) return;
                    logSorenessMusclePicker
                        .querySelectorAll(".doms-chip")
                        .forEach((chip) => {
                            const id = chip.dataset.muscle;
                            if (selectedLogSorenessMuscles.has(id)) {
                                chip.style.background =
                                    "rgba(0, 243, 255, 0.25)";
                                chip.style.borderColor =
                                    "rgba(0, 243, 255, 0.6)";
                            } else {
                                chip.style.background =
                                    "rgba(255, 255, 255, 0.08)";
                                chip.style.borderColor =
                                    "rgba(255, 255, 255, 0.12)";
                            }
                        });
                    updateLogSorenessHint();
                }

                function clearLogSorenessSelection() {
                    selectedLogSorenessMuscles.clear();
                    syncLogSorenessChips();
                    if (logExternalCause) logExternalCause.value = "";
                }

                // Initialize muscle picker
                buildLogSorenessPicker();
                // DOM Elements
                const startBtn = document.getElementById("startWorkoutBtn");
                const workoutSelector =
                    document.getElementById("workoutSelector");
                const savedWorkoutsSelect = document.getElementById(
                    "savedWorkoutsSelect",
                );
                const loadWorkoutBtn =
                    document.getElementById("loadWorkoutBtn");
                const cancelSelectBtn =
                    document.getElementById("cancelSelectBtn");

                const loggingArea = document.getElementById("loggingArea");
                const loggingTitle = document.getElementById("loggingTitle");
                const loggingFooterActions = document.getElementById(
                    "loggingFooterActions",
                );
                const fabContainer = document.getElementById("fabContainer");
                const logDate = document.getElementById("logDate");
                const logDuration = document.getElementById("logDuration");
                const logSleepQuality =
                    document.getElementById("logSleepQuality");
                const logEnergyLevel =
                    document.getElementById("logEnergyLevel");
                const logStressLevel =
                    document.getElementById("logStressLevel");
                const logSorenessLevel =
                    document.getElementById("logSorenessLevel");
                const exercisesLogContainer = document.getElementById(
                    "exercisesLogContainer",
                );
                const finishWorkoutBtn =
                    document.getElementById("finishWorkoutBtn");
                const cancelLogBtn = document.getElementById("cancelLogBtn");

                const historyList = document.getElementById("historyList");

                // State
                let currentWorkout = null;
                let editingLogIndex = -1; // -1 means creating new

                // Initialize Services
                let storageService;
                let unitService;
                try {
                    storageService =
                        window.storageService || new StorageService();
                    unitService = window.unitService || new UnitService();
                } catch (e) {
                    console.error("Services not available:", e);
                }

                // 1. Load Saved Workouts into Select
                let workoutsCache = [];
                function populateWorkoutSelect() {
                    workoutsCache = JSON.parse(
                        localStorage.getItem("ironflow_workouts") || "[]",
                    );
                    savedWorkoutsSelect.innerHTML =
                        '<option value="">-- Scegli una routine --</option>';
                    workoutsCache.forEach((w) => {
                        const opt = document.createElement("option");
                        opt.value = w.id;
                        opt.textContent = w.name;
                        savedWorkoutsSelect.appendChild(opt);
                    });
                }
                populateWorkoutSelect();

                // 2. Event Listeners for Navigation
                startBtn.addEventListener("click", () => {
                    editingLogIndex = -1;
                    finishWorkoutBtn.textContent = "Salva Allenamento";
                    fabContainer.style.display = "none";
                    workoutSelector.style.display = "block";
                    historyList.style.display = "none";

                    // üèÜ Reset sessione PR per nuovo allenamento
                    if (typeof prTracker !== "undefined") {
                        prTracker.resetSessionPRs();
                    }
                });

                cancelSelectBtn.addEventListener("click", () => {
                    workoutSelector.style.display = "none";
                    fabContainer.style.display = "block";
                    historyList.style.display = "block";
                });

                cancelLogBtn.addEventListener("click", () => {
                    if (
                        confirm(
                            "Sei sicuro di voler annullare? I dati inseriti andranno persi.",
                        )
                    ) {
                        closeLogging();
                    }
                });

                function closeLogging() {
                    loggingArea.style.display = "none";
                    loggingFooterActions.style.display = "none";
                    fabContainer.style.display = "block";
                    historyList.style.display = "block";
                    currentWorkout = null;
                    editingLogIndex = -1;
                    if (logSleepQuality) logSleepQuality.value = "";
                    if (logEnergyLevel) logEnergyLevel.value = "";
                    if (logStressLevel) logStressLevel.value = "";
                    if (logSorenessLevel) logSorenessLevel.value = "";
                    // Reset DOMS details
                    clearLogSorenessSelection();
                    if (domsDetailsContent)
                        domsDetailsContent.style.display = "none";
                    if (toggleDomsDetails)
                        toggleDomsDetails.textContent = "Espandi ‚ñº";
                }

                // 3. Load Workout for Logging
                loadWorkoutBtn.addEventListener("click", () => {
                    const workoutId = savedWorkoutsSelect.value;
                    if (!workoutId) {
                        alert("Seleziona una scheda per continuare.");
                        return;
                    }

                    currentWorkout = workoutsCache.find(
                        (w) => w.id == workoutId,
                    );
                    if (!currentWorkout) return;

                    // Setup UI
                    workoutSelector.style.display = "none";
                    loggingArea.style.display = "block";
                    loggingFooterActions.style.display = "flex";
                    fabContainer.style.display = "none";
                    loggingTitle.textContent = currentWorkout.name;
                    logDate.valueAsDate = new Date();
                    logDuration.value = "";
                    logSleepQuality.value = "";
                    logEnergyLevel.value = "";
                    logStressLevel.value = "";
                    logSorenessLevel.value = "";

                    renderLoggingForm(currentWorkout);
                });

                // 4. Render Logging Form (with full edit capabilities)
                function renderLoggingForm(workout, existingExercises = null) {
                    exercisesLogContainer.innerHTML = "";

                    // If editing, we might have different exercises than the base workout
                    const exercisesToRender =
                        existingExercises || workout.exercises;
                    const isEditing = editingLogIndex >= 0;

                    // Reset superset ID counter based on existing data
                    exercisesToRender.forEach((ex) => {
                        if (ex.supersetId) {
                            const idNum = parseInt(ex.supersetId.split("_")[1]);
                            if (!isNaN(idNum) && idNum >= nextSupersetId) {
                                nextSupersetId = idNum + 1;
                            }
                        }
                    });

                    exercisesToRender.forEach((ex, exIndex) => {
                        const exDiv = document.createElement("div");
                        exDiv.className = "exercise-log-item";
                        exDiv.dataset.exerciseIndex = exIndex;

                        // Superset classes and attributes
                        if (ex.supersetId) {
                            exDiv.dataset.supersetId = ex.supersetId;
                            exDiv.dataset.supersetRole = ex.supersetRole;
                            exDiv.classList.add("in-superset");
                        }

                        const unitLabel =
                            unitService &&
                            unitService.getSystem() === "imperial"
                                ? "Lbs"
                                : "Kg";

                        // Rest Configuration (Normal or Superset) - Allineato - Allineato
                        let restConfigHtml = "";
                        if (ex.supersetId && ex.supersetRole === "A") {
                            restConfigHtml = `
                            <div class="superset-rest-config visible" data-superset-id="${ex.supersetId}">
                                <div class="superset-rest-title">‚è±Ô∏è Recupero Superset</div>
                                <div class="superset-rest-grid">
                                    <span class="rest-label">A‚ÜíB:</span>
                                    <div class="rest-value-box">
                                        <input type="number" class="intra-rest-input" value="${ex.intraRest || 0}" min="0" max="60" placeholder="0">
                                        <span class="rest-suffix">sec</span>
                                    </div>
                                    <span class="rest-label">üîÅ Round:</span>
                                    <div class="rest-value-box">
                                        <input type="number" class="inter-rest-input" value="${ex.interRest || 90}" min="0" max="300" placeholder="90">
                                        <span class="rest-suffix">sec</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        } else if (!ex.supersetId) {
                            restConfigHtml = `
                            <div class="normal-rest-config">
                                <div class="rest-inline-box">
                                    <span class="rest-icon">‚è±Ô∏è</span>
                                    <input type="number" class="ex-rest" value="${ex.rest || 90}" placeholder="90">
                                    <span class="rest-suffix">sec</span>
                                </div>
                            </div>
                        `;
                        }

                        // Exercise header - INLINE compatto
                        let headerHtml = `
                        <div class="exercise-card-header">
                            <div class="drag-handle">‚ãÆ‚ãÆ</div>
                            ${ex.supersetId ? `<span class="superset-indicator">${ex.supersetRole}</span>` : ""}
                            <input type="text" class="exercise-name-input" value="${ex.name}" placeholder="Nome esercizio">
                            <div class="exercise-header-actions">
                                <button class="add-set-btn" data-exercise-index="${exIndex}"
                                        style="background: var(--color-primary); color: var(--color-bg); border: none; cursor: pointer;"
                                        title="Aggiungi set">+ Set</button>
                                ${
                                    exercisesToRender.length > 1
                                        ? `
                                <button class="remove-exercise-btn" data-exercise-index="${exIndex}"
                                        style="background: #ff4444; color: white; border: none; cursor: pointer;"
                                        title="Rimuovi esercizio">√ó</button>
                                `
                                        : ""
                                }
                            </div>
                        </div>
                        ${restConfigHtml}
                        <div class="set-header">
                            <span>#</span>
                            <span>Tipo</span>
                            <span>${unitLabel}</span>
                            <span>Reps</span>
                            <span>RPE</span>
                            <span></span>
                        </div>
                    `;

                        const setsToRender =
                            ex.sets || (Array.isArray(ex.sets) ? ex.sets : []);
                        let numSets = 3;
                        if (
                            Array.isArray(setsToRender) &&
                            setsToRender.length > 0
                        ) {
                            numSets = setsToRender.length;
                        } else if (workout.exercises[exIndex]) {
                            numSets =
                                parseInt(workout.exercises[exIndex].sets) || 3;
                        }

                        let setsHtml = "";
                        for (let i = 0; i < numSets; i++) {
                            let weight = "";
                            let reps = "";
                            let rpe = "";
                            let type = "normal";

                            if (
                                Array.isArray(setsToRender) &&
                                setsToRender[i]
                            ) {
                                let storedWeight = setsToRender[i].weight;
                                if (unitService) {
                                    weight =
                                        unitService.convertWeight(storedWeight);
                                } else {
                                    weight = storedWeight;
                                }
                                reps = setsToRender[i].reps;
                                rpe = setsToRender[i].rpe || "";
                                type = setsToRender[i].type || "normal";
                            } else {
                                if (workout.exercises[exIndex]) {
                                    reps =
                                        workout.exercises[exIndex].reps || "";
                                }
                            }

                            setsHtml += `
                            <div class="set-row" data-set-index="${i}">
                                <span class="set-label">${i + 1}</span>
                                <select class="set-type-select">
                                    ${getSetTypeOptions(type)}
                                </select>
                                <input type="number" class="set-input input-weight" placeholder="${unitLabel}" value="${weight}">
                                <input type="number" class="set-input input-reps" placeholder="Reps" value="${reps}">
                                <input type="number" class="set-input input-rpe" placeholder="RPE" value="${rpe}">
                                <button class="remove-set-btn" data-set-index="${i}"
                                        style="background: none; border: none; color: #ff4444; cursor: pointer; font-size: 1rem; padding: 0;"
                                        title="Rimuovi set">√ó</button>
                            </div>
                        `;
                        }

                        // Superset Controls - Compatto
                        const supersetControlsHtml = `
                        <div class="superset-controls">
                            <button type="button" class="superset-btn create-superset-btn" style="display: ${ex.supersetId ? "none" : "block"};">
                                üîó Superset
                            </button>
                            <button type="button" class="superset-btn remove-superset-btn" style="display: ${ex.supersetId ? "block" : "none"};">
                                ‚ùå Rimuovi
                            </button>
                        </div>
                    `;

                        exDiv.innerHTML =
                            headerHtml + setsHtml + supersetControlsHtml;
                        exercisesLogContainer.appendChild(exDiv);
                    });

                    // Add "New Exercise" button
                    const addExerciseBtn = document.createElement("button");
                    addExerciseBtn.className = "btn btn-outline";
                    addExerciseBtn.textContent = "+ Aggiungi Esercizio";
                    addExerciseBtn.style.width = "100%";
                    addExerciseBtn.style.marginTop = "1rem";
                    addExerciseBtn.addEventListener("click", addNewExercise);
                    exercisesLogContainer.appendChild(addExerciseBtn);

                    // Attach event listeners
                    attachExerciseControls();
                }

                // Add new exercise to the form
                function addNewExercise() {
                    const exerciseItems =
                        document.querySelectorAll(".exercise-log-item");
                    const newIndex = exerciseItems.length;

                    const exDiv = document.createElement("div");
                    exDiv.className = "exercise-log-item";
                    exDiv.dataset.exerciseIndex = newIndex;

                    const unitLabel =
                        unitService && unitService.getSystem() === "imperial"
                            ? "Lbs"
                            : "Kg";

                    exDiv.innerHTML = `
                    <div class="exercise-card-header">
                        <div class="drag-handle">‚ãÆ‚ãÆ</div>
                        <input type="text" class="exercise-name-input" value="" placeholder="Nome esercizio">
                        <div class="exercise-header-actions">
                            <button class="add-set-btn" data-exercise-index="${newIndex}"
                                    style="background: var(--color-primary); color: var(--color-bg); border: none; cursor: pointer;"
                                    title="Aggiungi set">+ Set</button>
                            <button class="remove-exercise-btn" data-exercise-index="${newIndex}"
                                    style="background: #ff4444; color: white; border: none; cursor: pointer;"
                                    title="Rimuovi esercizio">√ó</button>
                        </div>
                    </div>

                    <div class="normal-rest-config">
                        <div class="rest-inline-box">
                            <span class="rest-icon">‚è±Ô∏è</span>
                            <input type="number" class="ex-rest" value="90" placeholder="90">
                            <span class="rest-suffix">sec</span>
                        </div>
                    </div>

                    <div class="set-header">
                        <span>#</span>
                        <span>Tipo</span>
                        <span>${unitLabel}</span>
                        <span>Reps</span>
                        <span>RPE</span>
                        <span></span>
                    </div>
                    <div class="set-row" data-set-index="0">
                        <span class="set-label">1</span>
                        <select class="set-type-select">
                            ${getSetTypeOptions("normal")}
                        </select>
                        <input type="number" class="set-input input-weight" placeholder="${unitLabel}" value="">
                        <input type="number" class="set-input input-reps" placeholder="Reps" value="">
                        <input type="number" class="set-input input-rpe" placeholder="RPE" value="">
                        <button class="remove-set-btn" data-set-index="0"
                                style="background: none; border: none; color: #ff4444; cursor: pointer; font-size: 1rem; padding: 0;"
                                title="Rimuovi set">√ó</button>
                    </div>

                    <div class="superset-controls">
                        <button type="button" class="superset-btn create-superset-btn">
                            üîó Superset
                        </button>
                        <button type="button" class="superset-btn remove-superset-btn" style="display: none;">
                            ‚ùå Rimuovi
                        </button>
                    </div>
                `;

                    // Insert before the "Add Exercise" button
                    const addBtn =
                        exercisesLogContainer.querySelector(".btn-outline");
                    exercisesLogContainer.insertBefore(exDiv, addBtn);

                    attachExerciseControls();
                }

                // Attach controls for add/remove set and exercise
                function attachExerciseControls() {
                    // Add set buttons
                    document.querySelectorAll(".add-set-btn").forEach((btn) => {
                        btn.replaceWith(btn.cloneNode(true)); // Remove old listeners
                    });
                    document.querySelectorAll(".add-set-btn").forEach((btn) => {
                        btn.addEventListener("click", (e) => {
                            const exerciseDiv =
                                e.target.closest(".exercise-log-item");
                            // Find the set header to insert after, or the last set row
                            const lastSetRow =
                                exerciseDiv.querySelectorAll(".set-row");
                            const newSetIndex = lastSetRow.length;
                            const unitLabel =
                                unitService &&
                                unitService.getSystem() === "imperial"
                                    ? "Lbs"
                                    : "Kg";

                            const newSetRow = document.createElement("div");
                            newSetRow.className = "set-row";
                            newSetRow.dataset.setIndex = newSetIndex;
                            newSetRow.innerHTML = `
                            <span class="set-label">${newSetIndex + 1}</span>
                            <select class="set-type-select">
                                ${getSetTypeOptions("normal")}
                            </select>
                            <input type="number" class="set-input input-weight" placeholder="${unitLabel}" value="">
                            <input type="number" class="set-input input-reps" placeholder="Reps" value="">
                            <input type="number" class="set-input input-rpe" placeholder="RPE" value="">
                            <button class="remove-set-btn" data-set-index="${newSetIndex}"
                                    style="background: none; border: none; color: #ff4444; cursor: pointer; font-size: 1rem; padding: 0;"
                                    title="Rimuovi set">√ó</button>
                        `;

                            // Insert before superset controls
                            const supersetControls =
                                exerciseDiv.querySelector(".superset-controls");
                            exerciseDiv.insertBefore(
                                newSetRow,
                                supersetControls,
                            );

                            attachExerciseControls(); // Re-attach listeners
                        });
                    });

                    // Remove set buttons
                    document
                        .querySelectorAll(".remove-set-btn")
                        .forEach((btn) => {
                            btn.replaceWith(btn.cloneNode(true));
                        });
                    document
                        .querySelectorAll(".remove-set-btn")
                        .forEach((btn) => {
                            btn.addEventListener("click", (e) => {
                                const setRow = e.target.closest(".set-row");
                                const exerciseDiv =
                                    setRow.closest(".exercise-log-item");
                                setRow.remove();

                                // Renumber remaining sets
                                const remainingSets =
                                    exerciseDiv.querySelectorAll(".set-row");
                                remainingSets.forEach((row, idx) => {
                                    row.querySelector(
                                        ".set-label",
                                    ).textContent = idx + 1;
                                    row.dataset.setIndex = idx;
                                });
                            });
                        });

                    // Remove exercise buttons
                    document
                        .querySelectorAll(".remove-exercise-btn")
                        .forEach((btn) => {
                            btn.replaceWith(btn.cloneNode(true));
                        });
                    document
                        .querySelectorAll(".remove-exercise-btn")
                        .forEach((btn) => {
                            btn.addEventListener("click", (e) => {
                                if (confirm("Rimuovere questo esercizio?")) {
                                    const exerciseDiv =
                                        e.target.closest(".exercise-log-item");

                                    // If in superset, decouple first
                                    if (exerciseDiv.dataset.supersetId) {
                                        decoupleSuperset(
                                            exerciseDiv.dataset.supersetId,
                                        );
                                    }

                                    exerciseDiv.remove();

                                    // Renumber remaining exercises
                                    const remainingExercises =
                                        document.querySelectorAll(
                                            ".exercise-log-item",
                                        );
                                    remainingExercises.forEach((div, idx) => {
                                        div.dataset.exerciseIndex = idx;
                                    });
                                }
                            });
                        });

                    // Superset Creation Buttons
                    document
                        .querySelectorAll(".create-superset-btn")
                        .forEach((btn) => {
                            btn.replaceWith(btn.cloneNode(true));
                        });
                    document
                        .querySelectorAll(".create-superset-btn")
                        .forEach((btn) => {
                            btn.addEventListener("click", (e) => {
                                const currentExDiv =
                                    e.target.closest(".exercise-log-item");
                                const allExercises = Array.from(
                                    document.querySelectorAll(
                                        ".exercise-log-item",
                                    ),
                                );
                                const currentIndex =
                                    allExercises.indexOf(currentExDiv);
                                const nextExDiv =
                                    allExercises[currentIndex + 1];

                                if (!nextExDiv) {
                                    alert(
                                        "Aggiungi prima un altro esercizio per creare un superset.",
                                    );
                                    return;
                                }

                                if (
                                    currentExDiv.dataset.supersetId ||
                                    nextExDiv.dataset.supersetId
                                ) {
                                    alert(
                                        "Uno degli esercizi √® gi√† in un superset. Rimuovilo prima.",
                                    );
                                    return;
                                }

                                // Create Superset ID
                                const supersetId =
                                    "ss_" + Date.now() + "_" + nextSupersetId++;

                                // Update UI for A
                                currentExDiv.dataset.supersetId = supersetId;
                                currentExDiv.dataset.supersetRole = "A";
                                currentExDiv.classList.add("in-superset");

                                // Add Indicator A
                                const indicatorA =
                                    document.createElement("span");
                                indicatorA.className = "superset-indicator";
                                indicatorA.textContent = "Superset A";
                                const headerA = currentExDiv.querySelector(
                                    ".exercise-name-input",
                                ).parentElement.parentElement; // messy selector, better insert at top
                                currentExDiv.insertBefore(
                                    indicatorA,
                                    currentExDiv.firstChild,
                                );

                                // Add Rest Config A - Griglia allineata
                                const restConfigA = `
                            <div class="superset-rest-config visible" data-superset-id="${supersetId}">
                                <div class="superset-rest-title">‚è±Ô∏è Recupero Superset</div>
                                <div class="superset-rest-grid">
                                    <span class="rest-label">A‚ÜíB:</span>
                                    <div class="rest-value-box">
                                        <input type="number" class="intra-rest-input" value="0" min="0" max="60" placeholder="0">
                                        <span class="rest-suffix">sec</span>
                                    </div>
                                    <span class="rest-label">üîÅ Round:</span>
                                    <div class="rest-value-box">
                                        <input type="number" class="inter-rest-input" value="90" min="0" max="300" placeholder="90">
                                        <span class="rest-suffix">sec</span>
                                    </div>
                                </div>
                            </div>
                        `;
                                // Remove normal rest config
                                const normalRestA = currentExDiv.querySelector(
                                    ".normal-rest-config",
                                );
                                if (normalRestA) normalRestA.remove();

                                // Insert new rest config after header
                                currentExDiv
                                    .querySelector(".exercise-name-input")
                                    .parentElement.insertAdjacentHTML(
                                        "afterend",
                                        restConfigA,
                                    );

                                // Update Buttons A
                                currentExDiv.querySelector(
                                    ".create-superset-btn",
                                ).style.display = "none";
                                currentExDiv.querySelector(
                                    ".remove-superset-btn",
                                ).style.display = "block";

                                // Update UI for B
                                nextExDiv.dataset.supersetId = supersetId;
                                nextExDiv.dataset.supersetRole = "B";
                                nextExDiv.classList.add("in-superset");

                                // Add Indicator B
                                const indicatorB =
                                    document.createElement("span");
                                indicatorB.className = "superset-indicator";
                                indicatorB.textContent = "Superset B";
                                nextExDiv.insertBefore(
                                    indicatorB,
                                    nextExDiv.firstChild,
                                );

                                // Remove normal rest config B
                                const normalRestB = nextExDiv.querySelector(
                                    ".normal-rest-config",
                                );
                                if (normalRestB) normalRestB.remove();

                                // Update Buttons B
                                nextExDiv.querySelector(
                                    ".create-superset-btn",
                                ).style.display = "none";
                                nextExDiv.querySelector(
                                    ".remove-superset-btn",
                                ).style.display = "block";
                            });
                        });

                    // Superset Removal Buttons
                    document
                        .querySelectorAll(".remove-superset-btn")
                        .forEach((btn) => {
                            btn.replaceWith(btn.cloneNode(true));
                        });
                    document
                        .querySelectorAll(".remove-superset-btn")
                        .forEach((btn) => {
                            btn.addEventListener("click", (e) => {
                                const currentExDiv =
                                    e.target.closest(".exercise-log-item");
                                const supersetId =
                                    currentExDiv.dataset.supersetId;
                                if (supersetId) {
                                    decoupleSuperset(supersetId);
                                }
                            });
                        });
                }

                // Helper to break a superset
                function decoupleSuperset(supersetId) {
                    const exercises = document.querySelectorAll(
                        `.exercise-log-item[data-superset-id="${supersetId}"]`,
                    );
                    exercises.forEach((exDiv) => {
                        delete exDiv.dataset.supersetId;
                        delete exDiv.dataset.supersetRole;
                        exDiv.classList.remove("in-superset");

                        // Remove Indicator
                        const indicator = exDiv.querySelector(
                            ".superset-indicator",
                        );
                        if (indicator) indicator.remove();

                        // Remove Superset Rest Config
                        const ssRest = exDiv.querySelector(
                            ".superset-rest-config",
                        );
                        if (ssRest) ssRest.remove();

                        // Restore Normal Rest Config (if not present)
                        if (!exDiv.querySelector(".normal-rest-config")) {
                            const normalRestHtml = `
                            <div class="normal-rest-config">
                                <div class="rest-inline-box">
                                    <span class="rest-icon">‚è±Ô∏è</span>
                                    <input type="number" class="ex-rest" value="90" placeholder="90">
                                    <span class="rest-suffix">sec</span>
                                </div>
                            </div>
                        `;
                            const headerRow = exDiv.querySelector(
                                ".exercise-name-input",
                            ).parentElement;
                            headerRow.insertAdjacentHTML(
                                "afterend",
                                normalRestHtml,
                            );
                        }

                        // Reset Buttons
                        exDiv.querySelector(
                            ".create-superset-btn",
                        ).style.display = "block";
                        exDiv.querySelector(
                            ".remove-superset-btn",
                        ).style.display = "none";
                    });
                }

                function updateExerciseIndices() {
                    const exercises = Array.from(
                        exercisesLogContainer.querySelectorAll(
                            ".exercise-log-item",
                        ),
                    );
                    exercises.forEach((ex, idx) => {
                        ex.dataset.exerciseIndex = idx;
                        // Update index on buttons
                        const addBtn = ex.querySelector(".add-set-btn");
                        if (addBtn) addBtn.dataset.exerciseIndex = idx;
                        const removeBtn = ex.querySelector(
                            ".remove-exercise-btn",
                        );
                        if (removeBtn) removeBtn.dataset.exerciseIndex = idx;
                    });
                    refreshSupersets();
                }

                function refreshSupersets() {
                    const exercises = Array.from(
                        exercisesLogContainer.querySelectorAll(
                            ".exercise-log-item",
                        ),
                    );
                    exercises.forEach((ex, idx) => {
                        const sid = ex.dataset.supersetId;

                        if (sid) {
                            const prev = exercises[idx - 1];
                            const next = exercises[idx + 1];

                            let newRole = "";
                            if (next && next.dataset.supersetId === sid) {
                                newRole = "A";
                            } else if (
                                prev &&
                                prev.dataset.supersetId === sid
                            ) {
                                newRole = "B";
                            }

                            if (newRole) {
                                ex.dataset.supersetRole = newRole;
                                ex.classList.add("in-superset");

                                // Update indicator
                                let indicator = ex.querySelector(
                                    ".superset-indicator",
                                );
                                if (!indicator) {
                                    indicator = document.createElement("span");
                                    indicator.className = "superset-indicator";
                                    ex.insertBefore(indicator, ex.firstChild);
                                }
                                indicator.textContent = `Superset ${newRole}`;

                                // Handle visibility
                                const supersetConfig = ex.querySelector(
                                    ".superset-rest-config",
                                );
                                const normalConfig = ex.querySelector(
                                    ".normal-rest-config",
                                );

                                if (newRole === "A") {
                                    if (supersetConfig)
                                        supersetConfig.classList.add("visible");
                                    if (normalConfig)
                                        normalConfig.style.display = "none";
                                } else {
                                    if (supersetConfig)
                                        supersetConfig.classList.remove(
                                            "visible",
                                        );
                                    if (normalConfig)
                                        normalConfig.style.display = "none";
                                }

                                // Ensure buttons are correct
                                const createBtn = ex.querySelector(
                                    ".create-superset-btn",
                                );
                                const removeBtn = ex.querySelector(
                                    ".remove-superset-btn",
                                );
                                if (createBtn) createBtn.style.display = "none";
                                if (removeBtn)
                                    removeBtn.style.display = "inline-block";
                            } else {
                                // Lone superset exercise - break it
                                delete ex.dataset.supersetId;
                                delete ex.dataset.supersetRole;
                                ex.classList.remove("in-superset");
                                const indicator = ex.querySelector(
                                    ".superset-indicator",
                                );
                                if (indicator) indicator.remove();
                                const supersetConfig = ex.querySelector(
                                    ".superset-rest-config",
                                );
                                if (supersetConfig)
                                    supersetConfig.classList.remove("visible");
                                const normalConfig = ex.querySelector(
                                    ".normal-rest-config",
                                );
                                if (normalConfig)
                                    normalConfig.style.display = "flex";

                                const createBtn = ex.querySelector(
                                    ".create-superset-btn",
                                );
                                const removeBtn = ex.querySelector(
                                    ".remove-superset-btn",
                                );
                                if (createBtn)
                                    createBtn.style.display = "inline-block";
                                if (removeBtn) removeBtn.style.display = "none";
                            }
                        } else {
                            // Not in superset
                            ex.classList.remove("in-superset");
                            const indicator = ex.querySelector(
                                ".superset-indicator",
                            );
                            if (indicator) indicator.remove();
                            const normalConfig = ex.querySelector(
                                ".normal-rest-config",
                            );
                            if (normalConfig)
                                normalConfig.style.display = "flex";
                            const supersetConfig = ex.querySelector(
                                ".superset-rest-config",
                            );
                            if (supersetConfig)
                                supersetConfig.classList.remove("visible");

                            const createBtn = ex.querySelector(
                                ".create-superset-btn",
                            );
                            const removeBtn = ex.querySelector(
                                ".remove-superset-btn",
                            );
                            if (createBtn)
                                createBtn.style.display = "inline-block";
                            if (removeBtn) removeBtn.style.display = "none";
                        }
                    });
                }

                // Initialize Sortable
                if (window.Sortable) {
                    Sortable.create(exercisesLogContainer, {
                        animation: 150,
                        handle: ".drag-handle",
                        ghostClass: "sortable-ghost",
                        onEnd: function () {
                            updateExerciseIndices();
                        },
                    });
                }

                // 5. Save Workout Log
                const syncLogsToCloud = async () => {
                    // Usa il syncManager centralizzato
                    await syncManager.syncToCloud(true); // force=true per sync immediata
                };

                finishWorkoutBtn.addEventListener("click", async () => {
                    if (!logDuration.value) {
                        alert("Inserisci la durata dell'allenamento.");
                        return;
                    }

                    const logData = {
                        id: editingLogIndex >= 0 ? null : Date.now(),
                        workoutId: currentWorkout.id,
                        workoutName: currentWorkout.name,
                        date: logDate.value || new Date().toISOString(),
                        duration: logDuration.value + " min",
                        exercises: [],
                        totalVolume: 0,
                        fromAI: !!currentWorkout?.fromAI,
                    };
                    const sleepVal = parseInt(logSleepQuality.value, 10);
                    const energyVal = parseInt(logEnergyLevel.value, 10);
                    const stressVal = parseInt(logStressLevel.value, 10);
                    const sorenessVal = parseInt(logSorenessLevel.value, 10);
                    const externalCauseVal = logExternalCause
                        ? logExternalCause.value.trim()
                        : "";
                    const sorenessMusclesVal = Array.from(
                        selectedLogSorenessMuscles,
                    );

                    if (
                        [sleepVal, energyVal, stressVal, sorenessVal].some(
                            (val) => !Number.isNaN(val),
                        ) ||
                        sorenessMusclesVal.length > 0 ||
                        externalCauseVal
                    ) {
                        logData.wellness = {
                            sleepQuality: Number.isNaN(sleepVal)
                                ? null
                                : sleepVal,
                            energyLevel: Number.isNaN(energyVal)
                                ? null
                                : energyVal,
                            stressLevel: Number.isNaN(stressVal)
                                ? null
                                : stressVal,
                            sorenessLevel: Number.isNaN(sorenessVal)
                                ? null
                                : sorenessVal,
                            sorenessMuscles:
                                sorenessMusclesVal.length > 0
                                    ? sorenessMusclesVal
                                    : undefined,
                            sorenessLabels:
                                sorenessMusclesVal.length > 0
                                    ? sorenessMusclesVal.map(
                                          (id) =>
                                              MUSCLE_GROUPS[id]?.label || id,
                                      )
                                    : undefined,
                            externalCause: externalCauseVal || undefined,
                            recordedAt: new Date().toISOString(),
                        };
                    }

                    // Collect Data (including editable exercise names)
                    const exerciseItems =
                        document.querySelectorAll(".exercise-log-item");

                    exerciseItems.forEach((item) => {
                        // Get exercise name from input field (editable)
                        const exNameInput = item.querySelector(
                            ".exercise-name-input",
                        );
                        const exName = exNameInput
                            ? exNameInput.value.trim()
                            : "Esercizio";

                        if (!exName) {
                            return; // Skip exercises without name
                        }

                        const exData = {
                            name: exName,
                            sets: [],
                        };

                        // Superset Data
                        if (item.dataset.supersetId) {
                            exData.supersetId = item.dataset.supersetId;
                            exData.supersetRole = item.dataset.supersetRole;

                            // Rest Times for A
                            if (exData.supersetRole === "A") {
                                const intraInput =
                                    item.querySelector(".intra-rest-input");
                                const interInput =
                                    item.querySelector(".inter-rest-input");
                                if (intraInput)
                                    exData.intraRest =
                                        parseInt(intraInput.value) || 0;
                                if (interInput)
                                    exData.interRest =
                                        parseInt(interInput.value) || 90;
                            }
                        } else {
                            // Normal Rest
                            const restInput = item.querySelector(".ex-rest");
                            if (restInput)
                                exData.rest = parseInt(restInput.value) || 90;
                        }

                        const setRows = item.querySelectorAll(".set-row");

                        setRows.forEach((row) => {
                            let weightVal =
                                parseFloat(
                                    row.querySelector(".input-weight").value,
                                ) || 0;
                            const reps =
                                parseFloat(
                                    row.querySelector(".input-reps").value,
                                ) || 0;
                            const rpe =
                                parseFloat(
                                    row.querySelector(".input-rpe").value,
                                ) || 0;
                            const typeSelect =
                                row.querySelector(".set-type-select");
                            const type = typeSelect
                                ? typeSelect.value
                                : "normal";

                            if (weightVal > 0 && reps > 0) {
                                // Convert Input to Metric for Storage
                                let metricWeight = weightVal;
                                if (unitService) {
                                    metricWeight =
                                        unitService.toMetricWeight(weightVal);
                                }

                                exData.sets.push({
                                    weight: metricWeight,
                                    reps,
                                    rpe,
                                    type,
                                });
                                logData.totalVolume += metricWeight * reps;
                            }
                        });

                        if (exData.sets.length > 0) {
                            logData.exercises.push(exData);
                        }
                    });

                    if (logData.exercises.length === 0) {
                        alert(
                            "Inserisci almeno un set valido (peso e ripetizioni).",
                        );
                        return;
                    }

                    // Save to LocalStorage
                    const logs = JSON.parse(
                        localStorage.getItem("ironflow_logs") || "[]",
                    );

                    if (editingLogIndex >= 0) {
                        logData.id = logs[editingLogIndex].id;
                        logData.fromAI = logs[editingLogIndex].fromAI;
                        if (
                            !logData.wellness &&
                            logs[editingLogIndex].wellness
                        ) {
                            logData.wellness = logs[editingLogIndex].wellness;
                        }
                        logs[editingLogIndex] = logData;
                    } else {
                        logs.unshift(logData);
                    }

                    localStorage.setItem("ironflow_logs", JSON.stringify(logs));

                    // üèÜ RILEVAMENTO PR v2.0 - Accumula PRs nella sessione
                    // La notifica aggregata viene inviata sotto
                    try {
                        const newPRs = prTracker.detectPRsFromLog(logData);
                        if (newPRs.length > 0) {
                            console.log(
                                "üèÜ Nuovi PR rilevati in questo salvataggio:",
                                newPRs,
                            );
                        }
                    } catch (prError) {
                        console.warn("PR detection error:", prError);
                    }

                    await syncLogsToCloud();

                    // üèÜ NOTIFICA AGGREGATA POST-WORKOUT - Una sola notifica "Master"
                    try {
                        const sessionPRs = prTracker.getSessionPRs();
                        if (sessionPRs.length > 0) {
                            console.log(
                                "üèÜ Sessione completata con PRs:",
                                sessionPRs,
                            );
                            await prTracker.notifyAggregatedPRs();
                        }
                    } catch (prNotifyError) {
                        console.warn(
                            "PR aggregated notification error:",
                            prNotifyError,
                        );
                    }

                    // Reset UI
                    closeLogging();
                    renderLogs();

                    // Auto-Sync
                    if (storageService && storageService.hasCredentials()) {
                        // Show ephemeral status if possible, or just sync silently
                        await storageService.syncData();
                    }
                });

                // 6. Render History
                function renderLogs() {
                    const logs = JSON.parse(
                        localStorage.getItem("ironflow_logs") || "[]",
                    );
                    historyList.innerHTML = "";

                    if (logs.length === 0) {
                        historyList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìì</div>
                            <p class="empty-state-text">Nessun allenamento registrato</p>
                            <p style="font-size: 0.85rem; opacity: 0.7;">Premi ‚ûï per iniziare</p>
                        </div>
                    `;
                        return;
                    }

                    logs.forEach((log, index) => {
                        const date = new Date(log.date).toLocaleDateString(
                            "it-IT",
                            {
                                weekday: "short",
                                day: "numeric",
                                month: "short",
                            },
                        );
                        const div = document.createElement("div");
                        div.className = `log-entry ${log.fromAI ? "ai-generated" : "manual"}`;

                        // Format volume nicely - round and compact
                        let volumeDisplay = "";
                        const vol = log.totalVolume || 0;
                        if (unitService) {
                            const formatted = unitService.formatWeight(vol);
                            // Remove decimal if .0
                            volumeDisplay = formatted
                                .replace(".0 ", " ")
                                .replace(".0kg", "kg");
                        } else {
                            volumeDisplay =
                                vol >= 1000
                                    ? (vol / 1000)
                                          .toFixed(1)
                                          .replace(".0", "") + "t"
                                    : Math.round(vol) + "kg";
                        }

                        // Duration formatting
                        const durationVal =
                            typeof log.duration === "string"
                                ? log.duration
                                : log.duration + " min";

                        div.innerHTML = `
        <!-- Livello 1: Data + Azioni -->
        <div class="log-entry-header">
            <span class="log-date">${date}</span>
            <div class="log-actions">
                <button class="log-action-btn share-log-btn" data-id="${log.id}" title="Condividi">üîó</button>
                <button class="log-action-btn edit-log-btn" data-id="${log.id}" title="Modifica">‚úèÔ∏è</button>
                <button class="log-action-btn delete-btn delete-log-btn" data-id="${log.id}" title="Elimina">üóëÔ∏è</button>
            </div>
        </div>
        <!-- Livello 2: Titolo -->
        <div class="log-title">${log.workoutName}</div>
        <!-- Livello 3: Stats inline -->
        <div class="log-stats">
            <span class="stat-pill"><span class="stat-icon">‚è±Ô∏è</span> <span class="stat-value">${durationVal}</span></span>
            <span class="stat-pill"><span class="stat-icon">üèãÔ∏è</span> <span class="stat-value">${volumeDisplay}</span></span>
            ${log.fromAI ? '<span class="stat-pill ai-pill">‚ú® AI</span>' : ""}
        </div>
    `;
                        historyList.appendChild(div);
                    });

                    // Attach Listeners
                    document
                        .querySelectorAll(".delete-log-btn")
                        .forEach((btn) => {
                            btn.addEventListener("click", (e) => {
                                const logId =
                                    e.target.closest("button").dataset.id;
                                deleteLogById(logId);
                            });
                        });

                    document
                        .querySelectorAll(".edit-log-btn")
                        .forEach((btn) => {
                            btn.addEventListener("click", (e) => {
                                const logId =
                                    e.target.closest("button").dataset.id;
                                editLogById(logId);
                            });
                        });

                    document
                        .querySelectorAll(".share-log-btn")
                        .forEach((btn) => {
                            btn.addEventListener("click", async (e) => {
                                const logId =
                                    e.target.closest("button").dataset.id;
                                await shareLogById(logId);
                            });
                        });
                }

                window.addEventListener("storage", (event) => {
                    if (event.key === "ironflow_workouts") {
                        populateWorkoutSelect();
                    }
                    if (event.key === "ironflow_logs") {
                        renderLogs();
                    }
                });

                window.addEventListener("focus", () => {
                    populateWorkoutSelect();
                    renderLogs();
                });

                document.addEventListener("visibilitychange", () => {
                    if (!document.hidden) {
                        populateWorkoutSelect();
                        renderLogs();
                    }
                });

                // 7. Share Log by ID (UUID-based lookup)
                async function shareLogById(logId) {
                    const logs = JSON.parse(
                        localStorage.getItem("ironflow_logs") || "[]",
                    );
                    const log = logs.find(
                        (l) => String(l.id) === String(logId),
                    );
                    if (!log) {
                        alert("Log non trovato. Aggiorna la pagina.");
                        return;
                    }

                    const btn = document.querySelector(
                        `.share-log-btn[data-id="${logId}"]`,
                    );
                    const originalText = btn.textContent;
                    btn.textContent = "‚è≥";
                    btn.disabled = true;

                    try {
                        const shortId =
                            await firestoreService.createSharedWorkoutLog(log);
                        // Build clean share URL - use production URL, not localhost
                        let baseUrl;
                        if (
                            window.location.origin.includes("localhost") ||
                            window.location.origin.includes("capacitor")
                        ) {
                            // APK nativo o localhost - usa l'URL di produzione
                            baseUrl =
                                "https://massimilianociconte.github.io/Palestra/diary.html";
                        } else {
                            baseUrl = `${window.location.origin}${window.location.pathname}`;
                        }
                        const shareUrl = `${baseUrl}?log=${shortId}`;

                        showShareLogModal(log.workoutName, log.date, shareUrl);
                    } catch (error) {
                        console.error("Error sharing log:", error);
                        alert(
                            "Errore durante la condivisione: " + error.message,
                        );
                    } finally {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }
                }

                // Show share modal for logs
                function showShareLogModal(workoutName, date, shareUrl) {
                    const formattedDate = new Date(date).toLocaleDateString(
                        "it-IT",
                        {
                            weekday: "long",
                            day: "numeric",
                            month: "long",
                            year: "numeric",
                        },
                    );

                    const modalHTML = `
                    <div id="shareLogModal" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.95);
                        z-index: 3000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 1rem;
                    ">
                        <div class="card" style="max-width: 500px; width: 100%;">
                            <h3 style="margin-bottom: 1rem; color: var(--color-primary);">
                                üîó Condividi Allenamento
                            </h3>

                            <p style="margin-bottom: 0.5rem; color: var(--color-text-muted);">
                                Condividi <strong style="color: var(--color-text);">${workoutName}</strong>
                            </p>
                            <p style="margin-bottom: 1rem; font-size: 0.85rem; color: var(--color-text-muted);">
                                üìÖ ${formattedDate}
                            </p>

                            <div style="
                                background: rgba(255,255,255,0.05);
                                padding: 1rem;
                                border-radius: var(--radius-sm);
                                border: 1px solid var(--color-border);
                                margin-bottom: 1rem;
                                word-break: break-all;
                                font-family: monospace;
                                font-size: 0.85rem;
                                color: var(--color-primary);
                            ">
                                ${shareUrl}
                            </div>

                            <p style="font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: 1rem;">
                                Chi riceve questo link potr√† importare l'allenamento nel proprio diario.
                            </p>

                            <!-- Social Share Buttons -->
                            <div style="margin-bottom: 1rem;">
                                <p style="font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: 0.5rem;">Condividi su:</p>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    <button class="share-social-btn" data-platform="native" style="
                                        background: linear-gradient(135deg, #00f3ff, #0099ff);
                                        border: none;
                                        color: white;
                                        padding: 0.5rem 1rem;
                                        border-radius: var(--radius-sm);
                                        cursor: pointer;
                                        font-size: 0.85rem;
                                        display: flex;
                                        align-items: center;
                                        gap: 0.3rem;
                                    ">üì§ Condividi</button>
                                    <button class="share-social-btn" data-platform="whatsapp" style="
                                        background: #25D366;
                                        border: none;
                                        color: white;
                                        padding: 0.5rem 1rem;
                                        border-radius: var(--radius-sm);
                                        cursor: pointer;
                                        font-size: 0.85rem;
                                    ">WhatsApp</button>
                                    <button class="share-social-btn" data-platform="telegram" style="
                                        background: #0088cc;
                                        border: none;
                                        color: white;
                                        padding: 0.5rem 1rem;
                                        border-radius: var(--radius-sm);
                                        cursor: pointer;
                                        font-size: 0.85rem;
                                    ">Telegram</button>
                                    <button class="share-social-btn" data-platform="twitter" style="
                                        background: #1DA1F2;
                                        border: none;
                                        color: white;
                                        padding: 0.5rem 1rem;
                                        border-radius: var(--radius-sm);
                                        cursor: pointer;
                                        font-size: 0.85rem;
                                    ">X/Twitter</button>
                                    <button class="share-social-btn" data-platform="facebook" style="
                                        background: #1877F2;
                                        border: none;
                                        color: white;
                                        padding: 0.5rem 1rem;
                                        border-radius: var(--radius-sm);
                                        cursor: pointer;
                                        font-size: 0.85rem;
                                    ">Facebook</button>
                                    <button class="share-social-btn" data-platform="email" style="
                                        background: #666;
                                        border: none;
                                        color: white;
                                        padding: 0.5rem 1rem;
                                        border-radius: var(--radius-sm);
                                        cursor: pointer;
                                        font-size: 0.85rem;
                                    ">üìß Email</button>
                                </div>
                            </div>

                            <div style="display: flex; gap: 0.75rem;">
                                <button id="shareLogModalClose" class="btn btn-outline" style="flex: 1;">
                                    Chiudi
                                </button>
                                <button id="shareLogModalCopy" class="btn btn-primary" style="flex: 1;">
                                    üìã Copia Link
                                </button>
                            </div>

                            <p id="shareLogCopyFeedback" style="
                                text-align: center;
                                margin-top: 1rem;
                                margin-bottom: 0;
                                font-size: 0.85rem;
                                color: var(--color-primary);
                                min-height: 1.5em;
                            "></p>
                        </div>
                    </div>
                `;

                    document.body.insertAdjacentHTML("beforeend", modalHTML);

                    const modal = document.getElementById("shareLogModal");
                    const closeBtn =
                        document.getElementById("shareLogModalClose");
                    const copyBtn =
                        document.getElementById("shareLogModalCopy");
                    const feedback = document.getElementById(
                        "shareLogCopyFeedback",
                    );

                    closeBtn.addEventListener("click", () => modal.remove());

                    // Social share button handlers
                    const shareText = `Guarda il mio allenamento: ${workoutName} - ${formattedDate}`;
                    modal
                        .querySelectorAll(".share-social-btn")
                        .forEach((btn) => {
                            btn.addEventListener("click", () => {
                                const platform = btn.dataset.platform;
                                shareToSocialPlatform(
                                    platform,
                                    shareUrl,
                                    shareText,
                                );
                            });
                        });

                    copyBtn.addEventListener("click", async () => {
                        try {
                            await navigator.clipboard.writeText(shareUrl);
                            feedback.textContent =
                                "‚úÖ Link copiato negli appunti!";
                            copyBtn.textContent = "‚úÖ Copiato!";
                            setTimeout(() => {
                                copyBtn.textContent = "üìã Copia Link";
                            }, 2000);
                        } catch (error) {
                            feedback.textContent =
                                "üìã Seleziona e copia manualmente";
                        }
                    });
                }

                // Share to social platform helper
                function shareToSocialPlatform(platform, shareUrl, shareText) {
                    const encodedUrl = encodeURIComponent(shareUrl);
                    const encodedText = encodeURIComponent(shareText);

                    const socialUrls = {
                        whatsapp: `https://wa.me/?text=${encodedText}%20${encodedUrl}`,
                        telegram: `https://t.me/share/url?url=${encodedUrl}&text=${encodedText}`,
                        twitter: `https://twitter.com/intent/tweet?text=${encodedText}&url=${encodedUrl}`,
                        facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,
                        email: `mailto:?subject=${encodeURIComponent("Il mio allenamento")}&body=${encodedText}%20${encodedUrl}`,
                    };

                    if (platform === "native" && navigator.share) {
                        navigator
                            .share({
                                title: "Il mio allenamento",
                                text: shareText,
                                url: shareUrl,
                            })
                            .catch((err) =>
                                console.log("Share cancelled:", err),
                            );
                    } else if (platform === "native") {
                        // Fallback: copy to clipboard
                        navigator.clipboard.writeText(shareUrl).then(() => {
                            const feedback = document.getElementById(
                                "shareLogCopyFeedback",
                            );
                            if (feedback)
                                feedback.textContent = "‚úÖ Link copiato!";
                        });
                    } else if (socialUrls[platform]) {
                        window.open(
                            socialUrls[platform],
                            "_blank",
                            "width=600,height=400",
                        );
                    }
                }

                // Check for shared log on page load
                async function checkForSharedLog() {
                    const urlParams = new URLSearchParams(
                        window.location.search,
                    );
                    const logId = urlParams.get("log");

                    if (logId) {
                        console.log("Shared log detected:", logId);

                        try {
                            const logData =
                                await firestoreService.getSharedWorkoutLog(
                                    logId,
                                );

                            if (logData) {
                                // Generate new local ID and import
                                const importedLog = {
                                    id: Date.now(),
                                    ...logData,
                                    importedFrom: logId,
                                    importedAt: new Date().toISOString(),
                                };

                                // Save to local storage
                                const logs = JSON.parse(
                                    localStorage.getItem("ironflow_logs") ||
                                        "[]",
                                );
                                logs.unshift(importedLog);
                                localStorage.setItem(
                                    "ironflow_logs",
                                    JSON.stringify(logs),
                                );

                                // Sync to cloud
                                await syncLogsToCloud();

                                // Clean URL
                                window.history.replaceState(
                                    {},
                                    document.title,
                                    window.location.pathname,
                                );

                                // Show success notification
                                showImportNotification(
                                    logData.workoutName,
                                    true,
                                );

                                // Re-render
                                renderLogs();
                            }
                        } catch (error) {
                            console.error("Error importing shared log:", error);
                            showImportNotification(error.message, false);

                            // Clean URL
                            window.history.replaceState(
                                {},
                                document.title,
                                window.location.pathname,
                            );
                        }
                    }
                }

                // Show import notification
                function showImportNotification(message, success) {
                    const notification = document.createElement("div");
                    notification.style.cssText = `
                    position: fixed;
                    top: 100px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--color-surface);
                    border: 1px solid ${success ? "var(--color-primary)" : "#ff4444"};
                    padding: 1rem 1.5rem;
                    border-radius: var(--radius-md);
                    z-index: 4000;
                    box-shadow: 0 4px 12px ${success ? "rgba(0, 243, 255, 0.3)" : "rgba(255, 68, 68, 0.3)"};
                    animation: slideDown 0.3s ease-out;
                `;

                    notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.5rem;">${success ? "‚úÖ" : "‚ùå"}</span>
                        <div>
                            <strong style="color: ${success ? "var(--color-primary)" : "#ff4444"};">
                                ${success ? "Allenamento Importato!" : "Errore Importazione"}
                            </strong>
                            <div style="font-size: 0.85rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                                ${message}
                            </div>
                        </div>
                    </div>
                `;

                    // Add animation styles if not present
                    if (!document.getElementById("importAnimStyle")) {
                        const style = document.createElement("style");
                        style.id = "importAnimStyle";
                        style.textContent = `
                        @keyframes slideDown {
                            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
                            to { transform: translateX(-50%) translateY(0); opacity: 1; }
                        }
                    `;
                        document.head.appendChild(style);
                    }

                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 4000);
                }

                // Check for shared log on init
                checkForSharedLog();

                // 8. Delete Log by ID (UUID-based)
                async function deleteLogById(logId) {
                    if (
                        confirm(
                            "Sei sicuro di voler eliminare questo allenamento dal diario?",
                        )
                    ) {
                        const logs = JSON.parse(
                            localStorage.getItem("ironflow_logs") || "[]",
                        );
                        const index = logs.findIndex(
                            (l) => String(l.id) === String(logId),
                        );
                        if (index === -1) {
                            alert("Log non trovato. Aggiorna la pagina.");
                            return;
                        }
                        logs.splice(index, 1);
                        localStorage.setItem(
                            "ironflow_logs",
                            JSON.stringify(logs),
                        );

                        renderLogs();

                        await syncLogsToCloud();

                        if (storageService && storageService.hasCredentials()) {
                            await storageService.syncData();
                        }
                    }
                }

                // 8. Edit Log by ID (UUID-based)
                function editLogById(logId) {
                    const logs = JSON.parse(
                        localStorage.getItem("ironflow_logs") || "[]",
                    );
                    const index = logs.findIndex(
                        (l) => String(l.id) === String(logId),
                    );
                    if (index === -1) {
                        alert("Log non trovato. Aggiorna la pagina.");
                        return;
                    }
                    const log = logs[index];

                    editingLogIndex = index;

                    // Mock a currentWorkout object from the log data
                    currentWorkout = {
                        id: log.workoutId,
                        name: log.workoutName,
                        exercises: log.exercises,
                        fromAI: log.fromAI,
                    };

                    // Setup UI
                    fabContainer.style.display = "none";
                    historyList.style.display = "none";
                    loggingArea.style.display = "block";
                    loggingFooterActions.style.display = "flex";

                    loggingTitle.textContent = "Modifica: " + log.workoutName;
                    logDate.value = log.date.split("T")[0];
                    logDuration.value = parseFloat(log.duration) || "";
                    if (log.wellness) {
                        logSleepQuality.value = log.wellness.sleepQuality ?? "";
                        logEnergyLevel.value = log.wellness.energyLevel ?? "";
                        logStressLevel.value = log.wellness.stressLevel ?? "";
                        logSorenessLevel.value =
                            log.wellness.sorenessLevel ?? "";

                        // Load DOMS muscles
                        selectedLogSorenessMuscles.clear();
                        if (Array.isArray(log.wellness.sorenessMuscles)) {
                            log.wellness.sorenessMuscles.forEach((m) =>
                                selectedLogSorenessMuscles.add(m),
                            );
                        }
                        syncLogSorenessChips();

                        // Load external cause
                        if (logExternalCause) {
                            logExternalCause.value =
                                log.wellness.externalCause || "";
                        }

                        // Auto-expand DOMS section if there's data
                        if (
                            log.wellness.sorenessMuscles?.length > 0 ||
                            log.wellness.externalCause
                        ) {
                            domsDetailsContent.style.display = "block";
                            toggleDomsDetails.textContent = "Comprimi ‚ñ≤";
                        }
                    } else {
                        logSleepQuality.value = "";
                        logEnergyLevel.value = "";
                        logStressLevel.value = "";
                        logSorenessLevel.value = "";
                        clearLogSorenessSelection();
                    }
                    finishWorkoutBtn.textContent = "Aggiorna Allenamento";

                    renderLoggingForm(currentWorkout, log.exercises);
                }

                // Initial Render (immediate with local data)
                renderLogs();

                // Il SyncManager gestisce automaticamente:
                // - Caricamento dal cloud quando l'utente √® autenticato
                // - Auto-sync ogni 5 minuti
                // - Sync quando la pagina torna in focus
                
                // Listener per aggiornare la UI quando il sync completa
                syncManager.onSync((eventType, data) => {
                    if (eventType === 'load' || eventType === 'focus') {
                        console.log('üîÑ [Diary] Aggiornamento UI dopo sync');
                        renderLogs();
                        populateWorkoutSelect();
                    }
                });
            });
        </script>

        <!-- Stats Info Modal -->
        <div
            id="statsInfoModal"
            class="stats-info-modal-backdrop"
            onclick="closeStatsInfoModal(event)"
        >
            <div class="stats-info-modal" onclick="event.stopPropagation()">
                <h3 id="statsModalTitle">‚ÑπÔ∏è Titolo</h3>
                <div id="statsModalContent"></div>
                <button
                    class="stats-info-close-btn"
                    onclick="closeStatsInfoModal()"
                >
                    CHIUDI
                </button>
            </div>
        </div>

        <script>
            // Stats Info Modal - Contenuti specifici per ogni statistica
            const statsInfoContent = {
                sleep: {
                    title: "üò¥ Qualit√† del Sonno",
                    sections: [
                        {
                            heading: "üìä Cos'√®?",
                            text: "Un indicatore soggettivo (1-10) della qualit√† del tuo riposo notturno. Considera durata, profondit√† e sensazione di ristoro al risveglio.",
                        },
                        {
                            heading: "üß† Perch√© √® importante?",
                            text: "Il sonno √® il principale momento di <strong>recupero muscolare</strong> e <strong>rigenerazione del CNS</strong>. Durante il sonno profondo viene rilasciato l'ormone della crescita (GH), fondamentale per la sintesi proteica e la riparazione tissutale.",
                        },
                        {
                            heading: "‚ö° Come influisce sull'allenamento?",
                            text: "Un sonno scarso (1-4) riduce la <strong>forza massimale</strong> fino al 20%, peggiora i <strong>tempi di reazione</strong> e aumenta il rischio di infortuni. L'AI ridurr√† automaticamente intensit√† e volume se rileva pattern di sonno insufficiente.",
                        },
                    ],
                },
                energy: {
                    title: "üîã Livello di Energia",
                    sections: [
                        {
                            heading: "üìä Cos'√®?",
                            text: "Una valutazione soggettiva (1-10) della tua vitalit√† e prontezza fisica percepita. Riflette le tue riserve energetiche disponibili per l'allenamento.",
                        },
                        {
                            heading: "üß† Perch√© √® importante?",
                            text: 'L\'energia percepita √® un indicatore della tua <strong>"Readiness"</strong> (prontezza). Dipende da fattori come nutrizione, idratazione, qualit√† del sonno e stress accumulato. √à un segnale diretto del tuo sistema nervoso autonomo.',
                        },
                        {
                            heading: "‚ö° Come influisce sull'allenamento?",
                            text: "Con energia bassa (1-4), la <strong>capacit√† di reclutamento muscolare</strong> diminuisce e la fatica arriva prima. L'AI suggerir√† sessioni pi√π brevi o a intensit√† moderata, preservando la qualit√† del movimento e prevenendo il sovrallenamento.",
                        },
                    ],
                },
                stress: {
                    title: "üßò Livello di Stress",
                    sections: [
                        {
                            heading: "üìä Cos'√®?",
                            text: "Una misura soggettiva (1-10) del tuo stress psicofisico. Include stress lavorativo, emotivo, relazionale e ambientale. Valori alti indicano maggiore tensione.",
                        },
                        {
                            heading: "üß† Perch√© √® importante?",
                            text: "Lo stress cronico eleva il <strong>cortisolo</strong>, un ormone catabolico che ostacola la crescita muscolare e il recupero. Un CNS (Sistema Nervoso Centrale) stressato ha capacit√† ridotte di generare forza e coordinazione.",
                        },
                        {
                            heading: "‚ö° Come influisce sull'allenamento?",
                            text: "Con stress alto (7-10), l'allenamento intenso pu√≤ essere <strong>controproducente</strong>, aumentando ulteriormente il cortisolo. L'AI privileger√† sessioni a bassa intensit√† o attivit√† di recupero attivo per favorire la rigenerazione.",
                        },
                    ],
                },
                doms: {
                    title: "üí™ DOMS (Indolenzimento Muscolare)",
                    sections: [
                        {
                            heading: "üìä Cos'√®?",
                            text: "DOMS = Delayed Onset Muscle Soreness. √à l'indolenzimento muscolare a insorgenza ritardata (24-72h post-allenamento). Scala 1-10 dove 10 √® dolore intenso.",
                        },
                        {
                            heading: "üß† Perch√© √® importante?",
                            text: "I DOMS sono causati da <strong>micro-lesioni delle fibre muscolari</strong> e dalla risposta infiammatoria. Indicano che il muscolo sta riparando e adattandosi, ma DOMS eccessivi segnalano un recupero incompleto.",
                        },
                        {
                            heading: "‚ö° Come influisce sull'allenamento?",
                            text: "Allenare muscoli con DOMS intensi (7-10) riduce il <strong>ROM</strong> (Range of Motion) e la capacit√† contrattile, aumentando il rischio di infortuni. L'AI eviter√† di sovraccaricare i distretti ancora in fase di riparazione.",
                        },
                    ],
                },
            };

            function openStatsInfoModal(type) {
                const modal = document.getElementById("statsInfoModal");
                const titleEl = document.getElementById("statsModalTitle");
                const contentEl = document.getElementById("statsModalContent");

                if (!modal || !statsInfoContent[type]) return;

                const data = statsInfoContent[type];
                titleEl.textContent = data.title;

                contentEl.innerHTML = data.sections
                    .map(
                        (section) => `
                <div class="stats-info-section">
                    <h4>${section.heading}</h4>
                    <p>${section.text}</p>
                </div>
            `,
                    )
                    .join("");

                modal.classList.add("active");
                document.body.style.overflow = "hidden";
            }

            function closeStatsInfoModal(event) {
                if (event && event.target !== event.currentTarget) return;

                const modal = document.getElementById("statsInfoModal");
                if (modal) {
                    modal.classList.remove("active");
                    document.body.style.overflow = "";
                }
            }
        </script>
        <script type="module" src="./js/gymbro-chat.js"></script>
    </body>
</html>
